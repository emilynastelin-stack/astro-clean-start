---
import MainLayout from '../layouts/MainLayout.astro';
import SongCard from '../components/SongCard.astro';

// Get search query from URL parameters - but this will be cleared client-side if it's a refresh
const searchQuery = Astro.url.searchParams.get('q') || '';
console.log('Server-side searchQuery:', searchQuery);
---

<MainLayout>
  <!-- Top Search Bar -->
  <div style="background-color: rgba(128,128,128,0.75); width:100%; box-shadow:0 2px 6px rgba(0,0,0,0.1);">
    <div style="display:flex; justify-content:center; align-items:center; height:60px; padding:0 1rem;">
      <form style="display:flex; gap:0.5rem; max-width:600px; width:100%;" action="/results" method="get">
        <input type="text" name="q" data-translate-placeholder="search.placeholder" placeholder="Search for a composer..." value={searchQuery}
               style="flex:1; padding:0.5rem 1rem; border-radius:8px; border:1px solid #ccc; font-size:1rem;" />
        <button type="submit"
                style="padding:0.5rem 1rem; border-radius:8px; border:none; background-color:#800000; color:white; font-size:1rem; cursor:pointer;"
                data-translate="search.button">
          Search
        </button>
        <a href="/results" id="show-all-btn"
           style="padding:0.5rem 1rem; border-radius:8px; border:none; background-color:#800000; color:white; text-decoration:none; font-size:1rem; display:inline-flex; align-items:center; justify-content:center; cursor:pointer;"
           data-translate="search.showAll">
          Show All
        </a>
      </form>
    </div>
  </div>

  <!-- Panels -->
  <main style="display:flex; gap:1rem; padding:2rem; align-items:stretch;">

    <!-- Left Panel: Filters -->
    <div class="left-panel" style="flex:0 0 400px; display:flex;">
      <div class="filter-panel" style="flex:1;">
        <h2 data-translate="filter.title">Filters</h2>
        
        <fieldset>
          <legend data-translate="filter.country">Country</legend>
          <label><input type="checkbox" name="Country" value="Armenia" /> <span data-translate="country.armenia">Armenia</span></label>
          <label><input type="checkbox" name="Country" value="Russia" /> <span data-translate="country.russia">Russia</span></label>
          <label><input type="checkbox" name="Country" value="Ukraine" /> <span data-translate="country.ukraine">Ukraine</span></label>
          <label><input type="checkbox" name="Country" value="Georgia" /> <span data-translate="country.georgia">Georgia</span></label>
          <label><input type="checkbox" name="Country" value="Azerbaijan" /> <span data-translate="country.azerbaijan">Azerbaijan</span></label>
          <label><input type="checkbox" name="Country" value="Uzbekistan" /> <span data-translate="country.uzbekistan">Uzbekistan</span></label>
          <label><input type="checkbox" name="Country" value="Latvia" /> <span data-translate="country.latvia">Latvia</span></label>
          <label><input type="checkbox" name="Country" value="Estonia" /> <span data-translate="country.estonia">Estonia</span></label>
          <label><input type="checkbox" name="Country" value="Lithuania" /> <span data-translate="country.lithuania">Lithuania</span></label>
          <label><input type="checkbox" name="Country" value="Belarus" /> <span data-translate="country.belarus">Belarus</span></label>
          <label><input type="checkbox" name="Country" value="Moldova" /> <span data-translate="country.moldova">Moldova</span></label>
          <label><input type="checkbox" name="Country" value="Kyrgyzstan" /> <span data-translate="country.kyrgyzstan">Kyrgyzstan</span></label>
          <label><input type="checkbox" name="Country" value="Tajikistan" /> <span data-translate="country.tajikistan">Tajikistan</span></label>
          <label><input type="checkbox" name="Country" value="Turkmenistan" /> <span data-translate="country.turkmenistan">Turkmenistan</span></label>
          <label><input type="checkbox" name="Country" value="Kazakhstan" /> <span data-translate="country.kazakhstan">Kazakhstan</span></label>
        </fieldset>
        <fieldset>
          <legend data-translate="filter.republic">Soviet Republic</legend>
          <label><input type="checkbox" name="Soviet Republic" value="Armenian SSR" /> <span data-translate="republic.armenian">Armenian SSR</span></label>
          <label><input type="checkbox" name="Soviet Republic" value="Azerbaijan SSR" /> <span data-translate="republic.azerbaijan">Azerbaijan SSR</span></label>
          <label><input type="checkbox" name="Soviet Republic" value="Byelorussian SSR" /> <span data-translate="republic.byelorussian">Byelorussian SSR</span></label>
          <label><input type="checkbox" name="Soviet Republic" value="Estonian SSR" /> <span data-translate="republic.estonian">Estonian SSR</span></label>
          <label><input type="checkbox" name="Soviet Republic" value="Georgian SSR" /> <span data-translate="republic.georgian">Georgian SSR</span></label>
          <label><input type="checkbox" name="Soviet Republic" value="Kazakh SSR" /> <span data-translate="republic.kazakh">Kazakh SSR</span></label>
          <label><input type="checkbox" name="Soviet Republic" value="Kirghiz SSR" /> <span data-translate="republic.kirghiz">Kirghiz SSR</span></label>
          <label><input type="checkbox" name="Soviet Republic" value="Latvian SSR" /> <span data-translate="republic.latvian">Latvian SSR</span></label>
          <label><input type="checkbox" name="Soviet Republic" value="Lithuanian SSR" /> <span data-translate="republic.lithuanian">Lithuanian SSR</span></label>
          <label><input type="checkbox" name="Soviet Republic" value="Moldavian SSR" /> <span data-translate="republic.moldavian">Moldavian SSR</span></label>
          <label><input type="checkbox" name="Soviet Republic" value="Russian SFSR" /> <span data-translate="republic.russian">Russian SFSR</span></label>
          <label><input type="checkbox" name="Soviet Republic" value="Tajik SSR" /> <span data-translate="republic.tajik">Tajik SSR</span></label>
          <label><input type="checkbox" name="Soviet Republic" value="Turkmen SSR" /> <span data-translate="republic.turkmen">Turkmen SSR</span></label>
          <label><input type="checkbox" name="Soviet Republic" value="Ukrainian SSR" /> <span data-translate="republic.ukrainian">Ukrainian SSR</span></label>
          <label><input type="checkbox" name="Soviet Republic" value="Uzbek SSR" /> <span data-translate="republic.uzbek">Uzbek SSR</span></label>
        </fieldset>
        <fieldset>
          <legend data-translate="filter.gender">Gender</legend>
          <label><input type="checkbox" name="Gender" value="Male" /> <span data-translate="filter.male">Male</span></label>
          <label><input type="checkbox" name="Gender" value="Female" /> <span data-translate="filter.female">Female</span></label>
        </fieldset>
        <fieldset>
          <legend data-translate="filter.type">Type</legend>
          <label><input type="checkbox" name="Type" value="Scherzo" /> <span data-translate="filter.scherzo">Scherzo</span></label>
          <label><input type="checkbox" name="Type" value="Cornet solo" /> <span data-translate="filter.cornetSolo">Cornet solo</span></label>
          <label><input type="checkbox" name="Type" value="Sonata/Sonatina" /> <span data-translate="filter.sonata">Sonata/Sonatina</span></label>
          <label><input type="checkbox" name="Type" value="Concerto/Concertino" /> <span data-translate="filter.concerto">Concerto/Concertino</span></label>
          <label><input type="checkbox" name="Type" value="Poem" /> <span data-translate="filter.poem">Poem</span></label>
          <label><input type="checkbox" name="Type" value="Concert Piece" /> <span data-translate="filter.concertPiece">Concert Piece</span></label>
          <label><input type="checkbox" name="Type" value="Fantasy/variations" /> <span data-translate="filter.fantasy">Fantasy/variations</span></label>
        </fieldset>

      </div>
    </div>

    <!-- Center Panel: Results -->
    <div class="center-panel" style="flex:1; margin:0 1rem; display:flex;">
      <div style="background:white; border-radius:12px; padding:1.5rem; box-shadow:0 2px 6px rgba(0,0,0,0.1); flex:1;">
        <h3 style="margin-top:0; margin-bottom:1rem; color:#800000;" data-translate="results.title">Results</h3>
        <div id="results-list" style="display:flex; flex-direction:column; gap:1rem;">
          <p>Select filters to see composers.</p>
        </div>
      </div>
    </div>

    <!-- Right Panel: Composer Details -->
    <div class="right-panel" style="flex:0 0 400px; display:flex;">
      <div class="composer-details" style="flex:1;">
        <div class="composer-details-header" data-translate="composer.details">Additional Info</div>
        <div id="composer-details-content">
          <p data-translate="composer.select">Select a piece or composer to see more details here.</p>
        </div>
      </div>
    </div>

  </main>

  <!-- Mobile Composer Details Overlay -->
  <div id="mobile-overlay" class="mobile-overlay">
    <div class="mobile-overlay-content">
      <div class="mobile-overlay-header">
        <h3>Composer Details</h3>
        <button id="close-overlay" class="close-overlay">&times;</button>
      </div>
      <div id="mobile-composer-details" class="mobile-composer-details">
        <p>Select a composer to see details.</p>
      </div>
    </div>
  </div>

  <!-- Mobile Toolbar -->
  <div id="mobile-toolbar" class="mobile-toolbar">
    <button id="mobile-filter-btn" class="mobile-toolbar-btn">
      Filter
    </button>
  </div>

  <!-- Mobile Filter Panel -->
  <div id="mobile-filter-panel" class="mobile-filter-panel">
    <div class="mobile-filter-content">
      <div class="mobile-filter-header">
        <h3>Filters</h3>
        <button id="close-filter-panel" class="close-filter-panel">&times;</button>
      </div>
      <div class="mobile-filter-body">
        <fieldset>
          <legend data-translate="filter.country">Country</legend>
          <label><input type="checkbox" name="Country" value="Armenia" class="mobile-filter-checkbox" /> <span data-translate="country.armenia">Armenia</span></label>
          <label><input type="checkbox" name="Country" value="Russia" class="mobile-filter-checkbox" /> <span data-translate="country.russia">Russia</span></label>
          <label><input type="checkbox" name="Country" value="Ukraine" class="mobile-filter-checkbox" /> <span data-translate="country.ukraine">Ukraine</span></label>
          <label><input type="checkbox" name="Country" value="Georgia" class="mobile-filter-checkbox" /> <span data-translate="country.georgia">Georgia</span></label>
          <label><input type="checkbox" name="Country" value="Azerbaijan" class="mobile-filter-checkbox" /> <span data-translate="country.azerbaijan">Azerbaijan</span></label>
          <label><input type="checkbox" name="Country" value="Uzbekistan" class="mobile-filter-checkbox" /> <span data-translate="country.uzbekistan">Uzbekistan</span></label>
          <label><input type="checkbox" name="Country" value="Latvia" class="mobile-filter-checkbox" /> <span data-translate="country.latvia">Latvia</span></label>
          <label><input type="checkbox" name="Country" value="Estonia" class="mobile-filter-checkbox" /> <span data-translate="country.estonia">Estonia</span></label>
          <label><input type="checkbox" name="Country" value="Lithuania" class="mobile-filter-checkbox" /> <span data-translate="country.lithuania">Lithuania</span></label>
          <label><input type="checkbox" name="Country" value="Belarus" class="mobile-filter-checkbox" /> <span data-translate="country.belarus">Belarus</span></label>
          <label><input type="checkbox" name="Country" value="Moldova" class="mobile-filter-checkbox" /> <span data-translate="country.moldova">Moldova</span></label>
          <label><input type="checkbox" name="Country" value="Kyrgyzstan" class="mobile-filter-checkbox" /> <span data-translate="country.kyrgyzstan">Kyrgyzstan</span></label>
          <label><input type="checkbox" name="Country" value="Tajikistan" class="mobile-filter-checkbox" /> <span data-translate="country.tajikistan">Tajikistan</span></label>
          <label><input type="checkbox" name="Country" value="Turkmenistan" class="mobile-filter-checkbox" /> <span data-translate="country.turkmenistan">Turkmenistan</span></label>
          <label><input type="checkbox" name="Country" value="Kazakhstan" class="mobile-filter-checkbox" /> <span data-translate="country.kazakhstan">Kazakhstan</span></label>
        </fieldset>
        <fieldset>
          <legend data-translate="filter.republic">Soviet Republic</legend>
          <label><input type="checkbox" name="Soviet Republic" value="Armenian SSR" class="mobile-filter-checkbox" /> <span data-translate="republic.armenian">Armenian SSR</span></label>
          <label><input type="checkbox" name="Soviet Republic" value="Azerbaijan SSR" class="mobile-filter-checkbox" /> <span data-translate="republic.azerbaijan">Azerbaijan SSR</span></label>
          <label><input type="checkbox" name="Soviet Republic" value="Byelorussian SSR" class="mobile-filter-checkbox" /> <span data-translate="republic.byelorussian">Byelorussian SSR</span></label>
          <label><input type="checkbox" name="Soviet Republic" value="Estonian SSR" class="mobile-filter-checkbox" /> <span data-translate="republic.estonian">Estonian SSR</span></label>
          <label><input type="checkbox" name="Soviet Republic" value="Georgian SSR" class="mobile-filter-checkbox" /> <span data-translate="republic.georgian">Georgian SSR</span></label>
          <label><input type="checkbox" name="Soviet Republic" value="Kazakh SSR" class="mobile-filter-checkbox" /> <span data-translate="republic.kazakh">Kazakh SSR</span></label>
          <label><input type="checkbox" name="Soviet Republic" value="Kirghiz SSR" class="mobile-filter-checkbox" /> <span data-translate="republic.kirghiz">Kirghiz SSR</span></label>
          <label><input type="checkbox" name="Soviet Republic" value="Latvian SSR" class="mobile-filter-checkbox" /> <span data-translate="republic.latvian">Latvian SSR</span></label>
          <label><input type="checkbox" name="Soviet Republic" value="Lithuanian SSR" class="mobile-filter-checkbox" /> <span data-translate="republic.lithuanian">Lithuanian SSR</span></label>
          <label><input type="checkbox" name="Soviet Republic" value="Moldavian SSR" class="mobile-filter-checkbox" /> <span data-translate="republic.moldavian">Moldavian SSR</span></label>
          <label><input type="checkbox" name="Soviet Republic" value="Russian SFSR" class="mobile-filter-checkbox" /> <span data-translate="republic.russian">Russian SFSR</span></label>
          <label><input type="checkbox" name="Soviet Republic" value="Tajik SSR" class="mobile-filter-checkbox" /> <span data-translate="republic.tajik">Tajik SSR</span></label>
          <label><input type="checkbox" name="Soviet Republic" value="Turkmen SSR" class="mobile-filter-checkbox" /> <span data-translate="republic.turkmen">Turkmen SSR</span></label>
          <label><input type="checkbox" name="Soviet Republic" value="Ukrainian SSR" class="mobile-filter-checkbox" /> <span data-translate="republic.ukrainian">Ukrainian SSR</span></label>
          <label><input type="checkbox" name="Soviet Republic" value="Uzbek SSR" class="mobile-filter-checkbox" /> <span data-translate="republic.uzbek">Uzbek SSR</span></label>
        </fieldset>
        <fieldset>
          <legend data-translate="filter.gender">Gender</legend>
          <label><input type="checkbox" name="Gender" value="Male" class="mobile-filter-checkbox" /> <span data-translate="filter.male">Male</span></label>
          <label><input type="checkbox" name="Gender" value="Female" class="mobile-filter-checkbox" /> <span data-translate="filter.female">Female</span></label>
        </fieldset>
        <fieldset>
          <legend data-translate="filter.type">Type</legend>
          <label><input type="checkbox" name="Type" value="Scherzo" class="mobile-filter-checkbox" /> <span data-translate="filter.scherzo">Scherzo</span></label>
          <label><input type="checkbox" name="Type" value="Cornet solo" class="mobile-filter-checkbox" /> <span data-translate="filter.cornetSolo">Cornet solo</span></label>
          <label><input type="checkbox" name="Type" value="Sonata/Sonatina" class="mobile-filter-checkbox" /> <span data-translate="filter.sonata">Sonata/Sonatina</span></label>
          <label><input type="checkbox" name="Type" value="Concerto/Concertino" class="mobile-filter-checkbox" /> <span data-translate="filter.concerto">Concerto/Concertino</span></label>
          <label><input type="checkbox" name="Type" value="Poem" class="mobile-filter-checkbox" /> <span data-translate="filter.poem">Poem</span></label>
          <label><input type="checkbox" name="Type" value="Concert Piece" class="mobile-filter-checkbox" /> <span data-translate="filter.concertPiece">Concert Piece</span></label>
          <label><input type="checkbox" name="Type" value="Fantasy/variations" class="mobile-filter-checkbox" /> <span data-translate="filter.fantasy">Fantasy/variations</span></label>
        </fieldset>

      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script>
    console.log('Script tag loaded');
    
    // Function to normalize text for accent and umlaut handling
    // Examples: "Dvořák" -> "dvorak", "Müller" -> "muller", "Tchaikovsky" -> "tchaikovsky"
    function normalizeText(text) {
      if (!text || typeof text !== 'string') return '';
      
      return text
        .toLowerCase()
        .normalize('NFD') // Decompose accented characters (é -> e + ´)
        .replace(/[\u0300-\u036f]/g, '') // Remove accent marks (´, `, ^, ~, etc.)
        .replace(/[æ]/g, 'ae') // Nordic æ -> ae
        .replace(/[ø]/g, 'o')  // Nordic ø -> o
        .replace(/[å]/g, 'a')  // Nordic å -> a  
        .replace(/[ß]/g, 'ss') // German ß -> ss
        .replace(/[œ]/g, 'oe') // French œ -> oe
        .replace(/[ł]/g, 'l')  // Polish ł -> l
        .replace(/[ñ]/g, 'n'); // Spanish ñ -> n
    }
    
    // Check if this is a page refresh and clear search parameters
    function clearSearchOnRefresh() {
      // Check if the page was refreshed (has search params but no referrer from our domain)
      const urlParams = new URLSearchParams(window.location.search);
      const hasSearchParams = urlParams.has('q') || Array.from(urlParams.keys()).length > 0;
      
      console.log('Checking for refresh:', {
        hasSearchParams,
        referrer: document.referrer,
        currentUrl: window.location.href,
        searchParams: window.location.search
      });
      
      if (hasSearchParams) {
        const referrer = document.referrer;
        const currentDomain = window.location.origin;
        
        // Multiple ways to detect refresh:
        // 1. No referrer (direct refresh/F5)
        // 2. Referrer is same URL (refresh)
        // 3. Performance navigation type indicates reload
        const isDirectRefresh = !referrer;
        const isSamePageRefresh = referrer === window.location.href;
        const isPerformanceRefresh = window.performance && 
                                   window.performance.navigation && 
                                   window.performance.navigation.type === 1;
        
        if (isDirectRefresh || isSamePageRefresh || isPerformanceRefresh) {
          console.log('Page refresh detected, clearing search parameters', {
            isDirectRefresh,
            isSamePageRefresh,
            isPerformanceRefresh
          });
          
          // Clear URL parameters without page reload
          const newUrl = window.location.pathname;
          window.history.replaceState({}, document.title, newUrl);
          
          // Clear search input
          const searchInput = document.querySelector('input[name="q"]');
          if (searchInput) {
            searchInput.value = '';
          }
          
          // Clear all filter checkboxes
          document.querySelectorAll('input[type="checkbox"]').forEach(cb => {
            cb.checked = false;
          });
          
          return true; // Indicates search was cleared
        }
      }
      return false; // No clearing occurred
    }
    
    document.addEventListener('DOMContentLoaded', function() {
      console.log('DOM Content Loaded - Script is running!');
      
      // Add results-page class to body for footer styling
      document.body.classList.add('results-page');
      
      const centerPanel = document.getElementById('results-list');
      const searchInput = document.querySelector('input[name="q"]');
      const showAllBtn = document.getElementById('show-all-btn');
      const composerDetailsPanel = document.getElementById('composer-details-content');
      
      console.log('centerPanel element:', centerPanel);
      console.log('searchInput element:', searchInput);
      console.log('showAllBtn element:', showAllBtn);
      console.log('composerDetailsPanel element:', composerDetailsPanel);
      
      if (!centerPanel) {
        console.error('Could not find results-list element!');
        return;
      }
      
      // Check for refresh and clear search if needed
      const searchWasCleared = clearSearchOnRefresh();

      let composers = [];
      let currentPage = 1;
      const resultsPerPage = 15;
      let filteredResults = [];
    fetch('/api/sheets')
      .then(res => res.json())
      .then(data => { 
        console.log('Fetched data:', data);
        composers = data.rows; 
        console.log('Composers array:', composers);
        console.log('Number of composers:', composers.length);
        
        // Check if there's a search query from URL and apply it (unless cleared by refresh)
        if (!searchWasCleared) {
          let urlQuery = searchInput ? searchInput.value.trim() : '';
          console.log('URL search query detected:', urlQuery);
          console.log('Search input element:', searchInput);
          console.log('Search input value:', searchInput ? searchInput.value : 'NO INPUT ELEMENT');
          console.log('Current URL:', window.location.href);
          console.log('URL search params:', window.location.search);
          
          // Fallback: if the input value is empty, try to get it from URL params directly
          if (!urlQuery) {
            const urlParams = new URLSearchParams(window.location.search);
            const queryParam = urlParams.get('q');
            if (queryParam && searchInput) {
              console.log('Setting search input value from URL params:', queryParam);
              searchInput.value = queryParam;
              urlQuery = queryParam;
            }
          }
          
          if (urlQuery) {
            console.log('Applying initial search query:', urlQuery);
            updateResults(); // This will apply the search filter
          } else {
            console.log('No search query, showing all results');
            renderResults(composers); // show all initially if no search query
          }
        } else {
          console.log('Search was cleared due to refresh, showing all results');
          renderResults(composers); // show all results after refresh clearing
        }
      })
        .catch(err => console.error('Failed to fetch composers:', err));

      const filters = ['Country','Soviet Republic','Gender','Type'];
      const checkboxMap = {};

      filters.forEach(key => {
        checkboxMap[key] = document.querySelectorAll(`input[name="${key}"]`);
        console.log(`Found ${checkboxMap[key].length} checkboxes for ${key}`);
        checkboxMap[key].forEach((cb, index) => {
          cb.addEventListener('change', () => {
            console.log(`Filter checkbox changed: ${key} - ${cb.value} - ${cb.checked}`);
            
            // Clear the search input when a filter is changed
            if (searchInput) {
              searchInput.value = '';
              console.log('Search input cleared due to filter change');
            }
            
            clearComposerDetails(); // Clear composer details when filter changes
            updateResults(); // Then update the results
          });
        });
      });

      searchInput.addEventListener('input', updateResults);

      // Function to clear composer details panel
      function clearComposerDetails() {
        console.log('clearComposerDetails called');
        if (composerDetailsPanel) {
          console.log('Clearing composer details panel');
          const selectText = window.LanguageManager ? window.LanguageManager.getTranslation('composer.select') : 'Select a piece or composer to see more details here.';
          composerDetailsPanel.innerHTML = `<p>${selectText}</p>`;
        } else {
          console.log('composerDetailsPanel not found');
        }
      }

      function showComposerDetails(composer) {
        console.log('UPDATED - Showing details for:', composer);
        console.log('Available fields:', Object.keys(composer));
        console.log('Soviet Republic value:', `"${composer["Soviet Republic"]}"`);
        console.log('Gender value:', `"${composer.Gender}"`);
        console.log('Type value:', `"${composer.Type}"`);
        console.log('All field names:');
        Object.keys(composer).forEach(key => console.log(`"${key}": "${composer[key]}"`));
        
        if (!composer) {
          composerDetailsPanel.innerHTML = '<p>Select a piece or composer to see details here.</p>';
          return;
        }
        
        // Create composer details content using actual field mappings
        const detailsHTML = `
          <div class="composer-details-content">
            <h3>${composer.Composer}</h3>
            <p class="lifespan"><em>1923-1986</em></p>
            <br>
            <p><b><span data-translate="composer.russian">Russian</span>:</b> ${composer["Композитор"] || "—"}</p>
            ${composer.Y ? `<p><b><span data-translate="composer.native">Native Language</span>:</b> ${composer.Y}</p>` : ''}
            ${composer.X ? `<p><b>${composer.Y || "Native"}:</b> ${composer.X}</p>` : ''}
            ${composer.D && composer.E ? `<p><b>${composer.D}:</b> ${composer.E}</p>` : ''}
            <br>
            <p><b><span data-translate="composer.country">Country</span>:</b> <span class="country-value" data-country="${composer.Country || ""}">${composer.Country || "—"}</span></p>
            <p><b><span data-translate="composer.republic">Soviet Republic</span>:</b> <span class="republic-value" data-republic="${composer["Soviet Republic"] || ""}">${composer["Soviet Republic"] || "—"}</span></p>
            <br>
            <p><b><span data-translate="composer.gender">Gender</span>:</b> <span class="gender-value" data-gender="${composer.Gender || ""}">${composer.Gender || "—"}</span></p>
            ${composer.Notes && composer.Notes.trim() ? `<p><b><span data-translate="composer.notes">Notes</span>:</b> ${composer.Notes}</p>` : ''}
          </div>
        `;
        
        // Show in desktop panel or mobile overlay depending on screen size
        if (window.innerWidth <= 768) {
          // Mobile: Show in overlay
          const mobileOverlay = document.getElementById('mobile-overlay');
          const mobileDetailsContent = document.getElementById('mobile-composer-details');
          
          if (mobileOverlay && mobileDetailsContent) {
            mobileDetailsContent.innerHTML = detailsHTML;
            mobileOverlay.classList.add('show');
            
            // Translate the newly added content
            if (window.LanguageManager) {
              window.LanguageManager.translateComposerDetails(window.LanguageManager.currentLang);
            }
          }
        } else {
          // Desktop: Show in right panel
          composerDetailsPanel.innerHTML = detailsHTML;
          
          // Translate the newly added content
          if (window.LanguageManager) {
            window.LanguageManager.translateComposerDetails(window.LanguageManager.currentLang);
          }
        }
      }

      function updateResults() {
        console.log('updateResults called');
        let filtered = composers;

        // Filter by checkboxes
        filters.forEach(key => {
          const selected = Array.from(checkboxMap[key])
                                .filter(c => c.checked)
                                .map(c => c.value);
          if(selected.length>0){
            console.log(`Filtering by ${key}:`, selected);
            console.log(`Sample data values for ${key}:`, composers.slice(0,10).map(c => `"${c[key]}"`));
            const beforeFilter = filtered.length;
            
            filtered = filtered.filter(c => selected.includes(c[key]));
            
            console.log(`${key} filter: ${beforeFilter} -> ${filtered.length} results`);
          }
        });

        // Filter by search text with normalization
        const query = searchInput ? searchInput.value.trim() : '';
        console.log('Search query being applied:', query);
        if(query){
          const beforeSearch = filtered.length;
          const normalizedQuery = normalizeText(query);
          console.log('Normalized query:', normalizedQuery);
          
          filtered = filtered.filter(c => {
            const normalizedComposer = normalizeText(c.Composer);
            const normalizedTitle = normalizeText(c.Title || '');
            
            return normalizedComposer.includes(normalizedQuery) || 
                   normalizedTitle.includes(normalizedQuery);
          });
          
          console.log(`Search filter: ${beforeSearch} -> ${filtered.length} results for query "${query}" (normalized: "${normalizedQuery}")`);
        }

        renderResults(filtered);
      }

      function renderResults(filtered) {
        console.log('renderResults called with:', filtered.length, 'items');
        filteredResults = filtered;
        currentPage = 1; // Reset to first page when new results come in
        
        // Add updating animation
        const resultsContainer = centerPanel.parentElement;
        if (resultsContainer) {
          resultsContainer.classList.add('results-updating');
        }
        
        // Slight delay to show the updating state
        setTimeout(() => {
          if(filtered.length===0){
            const noResultsText = window.LanguageManager ? window.LanguageManager.getTranslation('results.noResults') : 'No music found for selected filters.';
            const helpText = window.LanguageManager ? window.LanguageManager.getTranslation('results.helpExpand') : 'You can help by expanding it';
            centerPanel.innerHTML=`<p>${noResultsText}</p><p><a href="/submit" style="color: #800000; text-decoration: underline; cursor: pointer;">${helpText}</a></p>`;
          } else {
            renderPage();
          }
          
          // Show results updated animation
          if (resultsContainer) {
            resultsContainer.classList.remove('results-updating');
            resultsContainer.classList.add('results-updated');
            
            // Remove the animation class after it completes
            setTimeout(() => {
              resultsContainer.classList.remove('results-updated');
            }, 600);
          }
        }, 150);
      }

      function renderPage() {
        const startIndex = (currentPage - 1) * resultsPerPage;
        const endIndex = startIndex + resultsPerPage;
        const pageResults = filteredResults.slice(startIndex, endIndex);
        const totalPages = Math.ceil(filteredResults.length / resultsPerPage);

        // Render current page of results
        const htmlContent = pageResults.map(c=>`
          <div class="song-card">
            <div class="song-title">${c.Title || 'Untitled'}</div>
            <div class="song-composer">${c.Composer}</div>
            ${c.Year ? `<div class="song-year">${c.Year}</div>` : ''}
          </div>
        `).join('');
        
        // Add pagination controls
        const paginationHTML = `
          <div class="pagination-controls" style="display: flex; justify-content: flex-end; align-items: center; gap: 0.5rem; margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #e0e0e0;">
            <span style="font-size: 0.9rem; color: #666;">Page ${currentPage} of ${totalPages} (${filteredResults.length} total)</span>
            <button id="prev-btn" ${currentPage === 1 ? 'disabled' : ''} style="padding: 0.25rem 0.5rem; border: 1px solid #800000; background: ${currentPage === 1 ? '#f0f0f0' : 'white'}; color: ${currentPage === 1 ? '#999' : '#800000'}; border-radius: 4px; cursor: ${currentPage === 1 ? 'not-allowed' : 'pointer'};">Previous</button>
            <button id="next-btn" ${currentPage === totalPages ? 'disabled' : ''} style="padding: 0.25rem 0.5rem; border: 1px solid #800000; background: ${currentPage === totalPages ? '#f0f0f0' : 'white'}; color: ${currentPage === totalPages ? '#999' : '#800000'}; border-radius: 4px; cursor: ${currentPage === totalPages ? 'not-allowed' : 'pointer'};">Next</button>
          </div>
        `;
        
        centerPanel.innerHTML = htmlContent + paginationHTML;
        
        // Add click handlers to song cards for composer details
        const songCards = centerPanel.querySelectorAll('.song-card');
        songCards.forEach((card, index) => {
          const originalIndex = startIndex + index;
          card.addEventListener('click', () => showComposerDetails(filteredResults[originalIndex]));
        });

        // Add pagination event listeners
        const prevBtn = document.getElementById('prev-btn');
        const nextBtn = document.getElementById('next-btn');
        
        if (prevBtn && !prevBtn.disabled) {
          prevBtn.addEventListener('click', () => {
            if (currentPage > 1) {
              currentPage--;
              renderPage();
            }
          });
        }
        
        if (nextBtn && !nextBtn.disabled) {
          nextBtn.addEventListener('click', () => {
            if (currentPage < totalPages) {
              currentPage++;
              renderPage();
            }
          });
        }
      }

    // Show All button clears filters and search
      showAllBtn.addEventListener('click', e=>{
        e.preventDefault();
        filters.forEach(key => checkboxMap[key].forEach(cb => cb.checked=false));
        searchInput.value='';
        renderResults(composers);
      });

      // Mobile functionality
      function setupMobileFeatures() {
        if (window.innerWidth <= 768) {
          const filterPanel = document.querySelector('.filter-panel');
          const composerDetails = document.querySelector('.composer-details');
          
          // Mobile filter panel toggle
          if (filterPanel) {
            filterPanel.classList.add('collapsed'); // Start collapsed on mobile
            
            const filterHeader = filterPanel.querySelector('h2');
            if (filterHeader) {
              // Remove existing listener if any
              filterHeader.removeEventListener('click', toggleFilterPanel);
              filterHeader.addEventListener('click', toggleFilterPanel);
            }
          }
          
          // Mobile composer details panel toggle
          if (composerDetails) {
            composerDetails.classList.add('collapsed'); // Start collapsed on mobile
            
            const detailsHeader = composerDetails.querySelector('.composer-details-header');
            if (detailsHeader) {
              // Remove existing listener if any
              detailsHeader.removeEventListener('click', toggleDetailsPanel);
              detailsHeader.addEventListener('click', toggleDetailsPanel);
            }
          }
        } else {
          // Remove mobile classes on desktop
          const filterPanel = document.querySelector('.filter-panel');
          const composerDetails = document.querySelector('.composer-details');
          
          if (filterPanel) {
            filterPanel.classList.remove('collapsed');
          }
          if (composerDetails) {
            composerDetails.classList.remove('collapsed');
          }
        }
      }

      function toggleFilterPanel() {
        const filterPanel = document.querySelector('.filter-panel');
        if (filterPanel) {
          filterPanel.classList.toggle('collapsed');
        }
      }

      function toggleDetailsPanel() {
        const composerDetails = document.querySelector('.composer-details');
        if (composerDetails) {
          composerDetails.classList.toggle('collapsed');
        }
      }

      // Setup mobile features
      setupMobileFeatures();
      
      // Re-setup on window resize
      window.addEventListener('resize', setupMobileFeatures);

      // Mobile overlay functionality
      const mobileOverlay = document.getElementById('mobile-overlay');
      const closeOverlayBtn = document.getElementById('close-overlay');

      // Close overlay when clicking close button
      if (closeOverlayBtn && mobileOverlay) {
        closeOverlayBtn.addEventListener('click', () => {
          mobileOverlay.classList.remove('show');
        });
      }

      // Close overlay when clicking outside content
      if (mobileOverlay) {
        mobileOverlay.addEventListener('click', (e) => {
          if (e.target === mobileOverlay) {
            mobileOverlay.classList.remove('show');
          }
        });
      }

      // Close overlay on escape key
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && mobileOverlay && mobileOverlay.classList.contains('show')) {
          mobileOverlay.classList.remove('show');
        }
        if (e.key === 'Escape' && mobileFilterPanel && mobileFilterPanel.classList.contains('show')) {
          mobileFilterPanel.classList.remove('show');
        }
      });

      // Mobile filter panel functionality
      const mobileFilterBtn = document.getElementById('mobile-filter-btn');
      const mobileFilterPanel = document.getElementById('mobile-filter-panel');
      const closeFilterPanelBtn = document.getElementById('close-filter-panel');

      // Open filter panel when clicking filter button
      if (mobileFilterBtn && mobileFilterPanel) {
        mobileFilterBtn.addEventListener('click', () => {
          mobileFilterPanel.classList.add('show');
        });
      }

      // Close filter panel when clicking close button
      if (closeFilterPanelBtn && mobileFilterPanel) {
        closeFilterPanelBtn.addEventListener('click', () => {
          mobileFilterPanel.classList.remove('show');
        });
      }

      // Close filter panel when clicking outside content
      if (mobileFilterPanel) {
        mobileFilterPanel.addEventListener('click', (e) => {
          if (e.target === mobileFilterPanel) {
            mobileFilterPanel.classList.remove('show');
          }
        });
      }

      // Connect mobile filter checkboxes to main filter system
      const mobileFilterCheckboxes = document.querySelectorAll('.mobile-filter-checkbox');
      mobileFilterCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', updateResults);
      });
      
    }); // Close DOMContentLoaded
  </script>

  <style>
    /* Background Images */
    body {
      background-image: url('https://i.imgur.com/ZENogwV.png');
      background-size: cover;
      background-position: center;
      background-attachment: fixed;
      background-repeat: no-repeat;
    }

    /* Mobile background override */
    @media (max-width: 768px) {
      body {
        background-image: url('https://i.imgur.com/vfMSV3G.png');
        background-size: cover;
        background-position: center;
        background-attachment: fixed;
        background-repeat: no-repeat;
      }
    }

    /* Global styles matching SongCard component */
    :global(.song-card) {
      background: white;
      border-radius: 12px;
      padding: 1rem 1.25rem;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
      transition: transform 0.2s ease, box-shadow 0.2s ease;
      cursor: pointer;
      margin-bottom: 1rem;
    }
    
    :global(.song-card:hover) {
      transform: translateY(-5px);
      box-shadow: 0 6px 14px rgba(0, 0, 0, 0.15);
    }
    
    :global(.song-title) {
      font-weight: bold;
      font-size: 1.1rem;
      color: #800000;
      margin-bottom: 0.25rem;
    }
    
    :global(.song-composer) {
      font-size: 1rem;
      color: #333;
      margin-bottom: 0.25rem;
    }
    
    :global(.song-year) {
      font-size: 0.9rem;
      color: #666;
    }
    
    /* Composer Details styles matching ComposerDetails component */
    .composer-details {
      background: white;
      border-radius: 12px;
      padding: 1.5rem;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      height: 100%;
    }
    
    .composer-details-header {
      color: #800000;
      font-weight: bold;
      font-size: 1.1rem;
      margin-bottom: 1rem;
    }
    
    :global(.composer-details-content h3) {
      color: #800000;
      margin: 0;
      font-size: 1.2rem;
    }
    
    :global(.composer-details-content .lifespan) {
      color: gray;
      font-size: 0.9rem;
      margin-top: 0.2rem;
      margin-bottom: 1rem;
    }
    
    :global(.composer-details-content p) {
      margin: 0.3rem 0;
      color: #333;
      font-size: 0.95rem;
    }
    
    /* Filter panel styling */
    .filter-panel {
      background-color: #fafafa;
      border-radius: 12px;
      padding: 1rem;
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      box-shadow: 0 4px 12px rgba(0,0,0,0.05);
      height: 100%;
    }
    
    .filter-panel h2 { 
      margin: 0 0 0.5rem 0; 
      color: #800000; 
      font-size: 1.2rem; 
    }
    
    .filter-panel fieldset {
      border: none;
      padding: 0;
      margin: 0.5rem 0;
    }
    
    .filter-panel legend {
      color: #800000;
      font-size: 1rem;
      font-weight: bold;
      margin-bottom: 0.25rem;
    }
    
    .filter-panel label { 
      display: flex; 
      align-items: center; 
      gap: 0.5rem; 
      cursor: pointer; 
      font-size: 0.95rem; 
      margin: 0.2rem 0;
    }

    /* Mobile responsive styles */
@media (max-width: 768px) {
  /* Hide left and right panels on mobile */
  .left-panel,
  .right-panel {
    display: none !important;
  }

  main {
    padding: 1rem !important;
    gap: 0 !important;
  }

  .center-panel {
    margin: 0 !important;
  }

  /* Search bar container */
  div[style*="background-color: rgba(128,128,128,0.75)"] {
    width: 100% !important;
    box-sizing: border-box;
    height: auto !important;
    padding: 1rem 15px !important;
    display: flex !important;
    justify-content: center;
  }

  /* Make search form flexible */
  div[style*="background-color: rgba(128,128,128,0.75)"] form {
    display: flex !important;
    flex-direction: row !important;
    align-items: center;
    justify-content: space-between;
    width: 100% !important;
    max-width: 600px;
    gap: 0.5rem !important;
    box-sizing: border-box;
  }

  /* Input should take most width */
  div[style*="background-color: rgba(128,128,128,0.75)"] input[type="text"] {
    flex: 1 1 auto;
    min-width: 0;
  }

  /* Search button smaller and tidy */
  div[style*="background-color: rgba(128,128,128,0.75)"] button {
    flex: 0 0 auto;
    width: auto;
    padding: 0.5rem 0.75rem; /* tighter padding */
    font-size: 0.9rem;
    border-radius: 6px;
    white-space: nowrap; /* prevent wrapping */
  }

  #show-all-btn {
    display: none !important;
  }
}

   /* ============================
   Mobile Overlay Styles
============================ */
/* Mobile Overlay Container */
.mobile-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100vw;
  height: 100vh;
  background: rgba(0, 0, 0, 0.5); /* semi-transparent background */
  display: flex;
  justify-content: flex-end; /* slide panel from right */
  opacity: 0;                /* initially invisible */
  pointer-events: none;      /* non-interactive when hidden */
  transition: opacity 0.3s ease;
  z-index: 1000;
}

/* Show overlay */
.mobile-overlay.show {
  opacity: 1;
  pointer-events: auto;
}

/* Sliding Panel Content */
.mobile-overlay-content {
  background: white;
  width: 85%;
  max-width: 400px;
  height: 100%;
  box-shadow: -4px 0 20px rgba(0, 0, 0, 0.3);
  display: flex;
  flex-direction: column;

  /* Start off-screen */
  transform: translateX(100%);
  transition: transform 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
  overflow-y: auto;
}

/* Slide in when overlay is active */
.mobile-overlay.show .mobile-overlay-content {
  transform: translateX(0);
}

/* Header + Close Button */
.mobile-overlay-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 1rem 1.5rem;
  border-bottom: 1px solid #eee;
  background: #f8f8f8;
  flex-shrink: 0;
}

.mobile-overlay-header h3 {
  margin: 0;
  color: #800000;
  font-size: 1.2rem;
  word-wrap: break-word;
  overflow-wrap: break-word;
}

.close-overlay {
  background: none;
  border: none;
  font-size: 1.5rem;
  color: #800000;
  cursor: pointer;
  padding: 0.5rem;
  line-height: 1;
}

.close-overlay:hover {
  background: rgba(128, 0, 0, 0.1);
  border-radius: 4px;
}

/* Content area inside panel */
.mobile-composer-details {
  padding: 2rem 1rem 2rem 1rem;
  flex: 1;
  overflow-y: auto;
}

.mobile-composer-details .composer-details-content h3 {
  margin-bottom: 1rem;
}

.mobile-composer-details .composer-details-content p {
  margin: 0.5rem 0;
  line-height: 1.5;
}

/* Hide mobile overlay on desktop */
@media (min-width: 769px) {
  .mobile-overlay {
    display: none !important;
  }
}

/* Mobile Toolbar Styles */
.mobile-toolbar {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  background: #800000;
  padding: 1rem 15px;
  display: none;
  justify-content: flex-start;
  z-index: 999;
  box-shadow: 0 -2px 6px rgba(0, 0, 0, 0.1);
}

.mobile-toolbar-btn {
  background: white;
  color: #800000;
  border: none;
  padding: 0.75rem 1.5rem;
  border-radius: 8px;
  font-weight: bold;
  font-size: 1rem;
  cursor: pointer;
  transition: background-color 0.2s ease, transform 0.1s ease;
}

.mobile-toolbar-btn:hover {
  background: #f0f0f0;
}

.mobile-toolbar-btn:active {
  transform: scale(0.98);
}

/* Show toolbar only on mobile */
@media (max-width: 768px) {
  .mobile-toolbar {
    display: flex;
  }
}

/* Mobile Filter Panel Styles */
.mobile-filter-panel {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0);
  z-index: 1001;
  display: block;
  visibility: hidden;
  transition: background-color 0.4s ease, visibility 0.4s ease;
}

.mobile-filter-panel.show {
  background: rgba(0, 0, 0, 0.5);
  visibility: visible;
}

.mobile-filter-content {
  position: absolute;
  top: 0;
  left: 0;
  width: 85%;
  height: 100vh;
  background: white;
  box-shadow: 4px 0 20px rgba(0, 0, 0, 0.3);
  display: flex;
  flex-direction: column;
  transform: translateX(-100%);
  transition: transform 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
}

.mobile-filter-panel.show .mobile-filter-content {
  transform: translateX(0);
}

.mobile-filter-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 1rem 10px 1rem 1.5rem;
  border-bottom: 1px solid #eee;
  background: #f8f8f8;
  flex-shrink: 0;
}

.mobile-filter-header h3 {
  margin: 0;
  color: #800000;
  font-size: 1.2rem;
}

.close-filter-panel {
  background: none;
  border: none;
  font-size: 1.5rem;
  color: #800000;
  cursor: pointer;
  padding: 0.5rem;
  line-height: 1;
}

.close-filter-panel:hover {
  background: rgba(128, 0, 0, 0.1);
  border-radius: 4px;
}

.mobile-filter-body {
  padding: 1rem 10px 1rem 1rem;
  overflow-y: auto;
  flex: 1;
}

.mobile-filter-body fieldset {
  border: none;
  padding: 0;
  margin: 1rem 0;
}

.mobile-filter-body legend {
  color: #800000;
  font-size: 1rem;
  font-weight: bold;
  margin-bottom: 0.5rem;
}

.mobile-filter-body label {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  cursor: pointer;
  font-size: 0.95rem;
  margin: 0.3rem 0;
  padding: 0.2rem 0;
}

.mobile-filter-checkbox {
  min-width: 18px;
  height: 18px;
}

    /* Hide filter panel on desktop */
    @media (min-width: 769px) {
      .mobile-filter-panel {
        display: none !important;
      }
    }

    /* Results update animation - mobile only */
    @media (max-width: 768px) {
      .results-updating {
        opacity: 0.6;
        transform: scale(0.98);
        transition: opacity 0.3s ease, transform 0.3s ease;
      }

      .results-updated {
        animation: resultsFlash 0.6s ease-out;
      }

      @keyframes resultsFlash {
        0% {
          opacity: 0.6;
          transform: scale(0.98);
          background-color: white;
        }
        50% {
          opacity: 1;
          transform: scale(1.01);
          background-color: rgba(128, 128, 128, 0.1);
          box-shadow: 0 4px 20px rgba(128, 128, 128, 0.3);
        }
        100% {
          opacity: 1;
          transform: scale(1);
          background-color: white;
          box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
        }
      }
    }